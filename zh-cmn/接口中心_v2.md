# 接口中心

## 概述

本协议接口统一使用 HTTPS 协议，客户端向服务端发送数据使用 UTF-8 编码，使用 json 格式。

**获取单个设备资源请考虑使用"获取设备或群组的状态接口"，尽量少请求"首页接口"**

### 调用规范（重要）

- 单个 IP 对相同接口调用时间间隔应尽量大于等于 500ms，5 分钟内调用次数不超过 300 次，如果使用 WebSocket 方式控制我们的设备，请注意单个用户不应该短时间内反复上线（发送 userOnline 指令），短时间内上报次数过多会被服务器封锁 IP 和停用（如果业务情况必须这样，则可申请 IP 白名单）。
- 经过商务认证的合作伙伴和付费购买 APPID 的企业，使用「付费 APPID」请求所有接口总调用次数暂不限制（根据对接设备数量与用户数量换算，超过正式使用量则提前通知，忽略有可能在当月封禁使用），对短时间内的调用频次的限制和上述第一点保持一致。
- 对于企业或者个人开发者申请的 APPID，目前开放 部分已授权品牌的设备、以及主流设备类型（文档即将分批次发布，敬请期待），如需接入其他高级设备类型或计划支持新设备类型，请直接联系对接业务人员或邮件联系 [bd@coolkit.cn](mailto:bd@coolkit.cn)。

### 通用参数

与旧 API 接口相比，以前的通用参数做如下改动:

- 删除 ts 和 version 参数
- appid 不再通过 GET 方法的 queryString 或 POST 方法的 body 传入，而是统一通过 http headers 传入，并且只需在【用户】分类下的接口必须填写，其它接口不再需要
- nonce 不再通过 GET 方法的 queryString 或 POST 方法的 body 传入，而是统一通过 http headers 传入，并且校验必须为长度 8 的字符串，只能为大小写字母和数字

access token 的使用方式不变。总结如下

| **Http Header** | **是否允许为空**               | **说明**                                                                                                                                                                                               |
| :-------------- | :----------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| X-CK-Appid      | 【用户】分类下的接口不允许为空 | APPID，APP 的标识，需要付费购买的凭证                                                                                                                                                                  |
| X-CK-Nonce      | 允许为空                       | 长度 8 的大小写字母和数字，客户端应尽量使用随机字符串                                                                                                                                                  |
| Authorization   | 不允许为空                     | API 调用凭证，格式为 "Sign {Sign}" 或者 "Bearer {at}"，签名计算方法见 [开发文档/签名规则](/zh-cmn/开发文档_v2?id=签名规则)，at 全称是 Access Token，在登录、注册、重置密码、刷新 AT 接口中可以获取到。 |
| Content-Type    | PUT 和 POST 的请求不允许为空   | 固定为 "application/json" 或者 "application/json; charset=utf-8"                                                                                                                                       |
| Host            | 不允许为空                     | 大部分 HTTP 客户端会自动添加此字段，如果没有，必须代码明确指定，值为对应的接口域名，比如: cn-apia.coolkit.cn, us-apia.coolkit.cc                                                                       |

### 接口域名

- 中国: https://cn-apia.coolkit.cn
- 亚洲: https://as-apia.coolkit.cc
- 美洲: https://us-apia.coolkit.cc
- 欧洲: https://eu-apia.coolkit.cc

注意： 中国区（内陆）的域名为 **.cn**，其它地区环境的域名为 **.cc**

### 接口返回格式

本协议所有接口返回的数据都使用 UTF-8 编码，使用 json 格式。数据格式如下

| **名称** | **类型** | **允许为空** | **说明**                                                                                                         |
| :------- | :------- | :----------- | :--------------------------------------------------------------------------------------------------------------- |
| error    | Int      | N            | 错误码，0 代表无错误，1000 以内为通用错误码，参见本协议的【通用错误码】部分，1000 以上的错误码由不同接口给出定义 |
| data     | Object   | N            | 接口数据                                                                                                         |
| msg      | String   | N            | 错误信息，error=0 时为空字符串""，其它情况根据不同接口给出，以便调试                                             |

举例 1: 接口成功返回

```json
{
  "error": 0,
  "msg": "",
  "data": {
    "data1": "xxx",
    "data2": "yyy"
  }
}
```

举例 2: 接口错误返回

```json
{
  "error": 403,
  "msg": "api not found",
  "data": {}
}
```

### Postman 示例

**Postman 示例下载：[点击下载](https://raw.githubusercontent.com/CoolKit-Technologies/eWeLink-API/main/media/files/CoolKit_API_Postman_Demo.zip)**

导入 [Postman](https://www.postman.com/downloads/)，在环境变量中填写自己的应用信息即可使用。

导入教程：[点击我](https://learning.postman.com/docs/getting-started/importing-and-exporting-data/)

### JavaScript 示例

推荐使用 pnpm, 下载 `ewelink-api-next`(node >= 16.16)

```bash
pnpm i ewelink-api-next
# or npm install ewelink-api-next
```

#### 代码示例

```typescript
// eWeLink v2 API

import eWeLink from 'ewelink-api-next'

const client = new eWeLink.WebAPI({
  appId: 'xxx',
  appSecret: 'xxx',
  region: 'us',
  logObj: eWeLink.createLogger('us'), // or console
})

client.syncLocalToken((region = 'us'), (account = 'xxx@xxx.net'))
try {
  const response = await client.user.login({
    account: 'xxx@xxx.com',
    password: '12345678',
    areaCode: '+1',
  })
  const userInfo = response.error === 0 ? response.data.user : {}
  console.log('userInfo：', userInfo)
} catch (err) {
  console.log('Failed to get user information:', err.message)
}
```

```typescript
// eWeLink WebSocket API

import eWeLink from 'ewelink-api-next'

const wsClient = new eWeLink.Ws({
  appId: 'xxx',
  appSecret: 'xxx',
  region: 'us',
})
wsClient.syncLocalToken((region = 'us'), (account = 'xxx@xxx.net'))

let ws = await wsClient.Connect.create({
  appId: wsClient?.appId || '',
  at: wsClient.at,
  region: 'us',
  userApiKey: wsClient.userApiKey,
})

setTimeout(() => {
  wsClient.Connect.updateState('xxxx', {
    switch: 'on',
  })
}, 5000)
```

```typescript
// eWeLink Lan Control
import eWeLink from 'ewelink-api-next'

const lanClient = new eWeLink.Lan({
  selfApikey: 'xxx',
  logObj: eWeLink.createLogger('lan'),
})

lanClient.discovery((server) => {
  console.log('server:', server)
}) // Start Discovery Service
try {
  const res = await lanClient.zeroconf.switches({
    data: {
      switch: 'on',
    },
    deviceId: 'xxx',
    secretKey: 'xxx',
  })
  console.info('Request result:：', res)
  const res2 = await lanClient.zeroconf.switches({
    data: {
      switch: 'off',
    },
    deviceId: 'xxx',
    secretKey: 'xxx',
  })
  console.info('Request result:：', res2)
} catch (error: any) {
  console.info(error.message)
}
```

## 用户

### 查询区域

该接口为全球接口，所有区域调用该接口时的 url 为同一个 URL: https://apia.coolkit.cn/v2/utils/get-region

请求方法：GET

认证参数：Sign

请求参数：

| **名称**    | **类型** | **允许为空** | **说明**                               |
| :---------- | :------- | :----------- | :------------------------------------- |
| countryCode | String   | N            | 电话区号，不需要带 "+" 符号，比如 “86” |

响应 data 参数:

| **名称** | **类型** | **允许为空** | **说明**                                                                             |
| :------- | :------- | :----------- | :----------------------------------------------------------------------------------- |
| region   | String   | N            | 用户所选电话区号对应的区域有以下情况：as:亚洲区；cn:中国内陆区；us:美洲区；eu:欧洲区 |

### 账号注册

账号注册规则：

- CN 区域：+86 手机号码
- AS 区域：菲律宾 +63、越南 +84、柬埔寨 +855、老挝 +856、马来西亚 +60、新加坡 +65、缅甸 +95、泰国 +66、文莱+673、印度尼西亚 +62、东帝汶 +670、伊朗 +98、中国台湾 +886 的 13 个地区支持使用手机号码注册登录，但不支持验证码登录，AS 区域 12 个国家和中国台湾在注册的时候提示“请输入手机或邮箱 ”，其余的国家地区按照原来的不变，即国外的提示“请输入邮箱”，国内的提示：“请填写你的电话”；AS 区域 12 个国家和台湾用户使用手机号注册时在填写验证码页面 1 分钟倒计时结束提示文案：“如未收到验证码，请先检查选择的国家码是否正确再点击发送验证码”，邮箱注册用户在验证码填写 1 分钟倒计时结束的时候并保持原来的提示不变，即“验证码可能存在延迟，3 分钟后未收到再点击发送验证码”。
- 密码规则：8 位以上数字字母字符任选其二组合。

区号表:

```JavaScript
const AreaCodes = [
    { "+86": "中国" },
    { "+93": "阿富汗" },
    { "+355": "阿尔巴尼亚" },
    { "+213": "阿尔及利亚" },
    { "+376": "安道尔共和国" },
    { "+244": "安哥拉" },
    { "+1264": "安圭拉岛" },
    { "+247": "阿森松" },
    { "+1268": "安提瓜和巴布达" },
    { "+54": "阿根廷" },
    { "+374": "亚美尼亚" },
    { "+297": "阿鲁巴岛" },
    { "+61": "澳大利亚" },
    { "+43": "奥地利" },
    { "+994": "阿塞拜疆" },
    { "+1242": "巴哈马" },
    { "+973": "巴林" },
    { "+880": "孟加拉国" },
    { "+1246": "巴巴多斯" },
    { "+375": "白俄罗斯" },
    { "+32": "比利时" },
    { "+501": "伯利兹" },
    { "+229": "贝宁" },
    { "+1441": "百慕大群岛" },
    { "+975": "不丹王国" },
    { "+591": "玻利维亚" },
    { "+387": "波斯尼亚和黑塞哥维那" },
    { "+267": "博茨瓦纳" },
    { "+55": "巴西" },
    { "+673": "文莱" },
    { "+359": "保加利亚" },
    { "+226": "布基纳法索" },
    { "+257": "布隆迪" },
    { "+855": "柬埔寨" },
    { "+237": "喀麦隆" },
    { "+1": "加拿大" },
    { "+238": "佛得角共和国" },
    { "+1345": "开曼群岛" },
    { "+236": "中非共和国" },
    { "+235": "乍得" },
    { "+56": "智利" },
    { "+57": "哥伦比亚" },
    { "+269": "科摩罗伊斯兰联邦共和国" },
    { "+242": "刚果共和国" },
    { "+243": "刚果民主共和国" },
    { "+682": "库克群岛" },
    { "+506": "哥斯达黎加" },
    { "+225": "科特迪瓦" },
    { "+385": "克罗地亚" },
    { "+53": "古巴" },
    { "+357": "塞浦路斯" },
    { "+420": "捷克" },
    { "+45": "丹麦" },
    { "+253": "吉布提" },
    { "+1767": "多米尼克" },
    { "+1809": "多米尼加共和国" },
    { "+593": "厄瓜多尔" },
    { "+20": "埃及" },
    { "+503": "萨尔瓦多" },
    { "+372": "爱沙尼亚" },
    { "+251": "埃塞俄比亚" },
    { "+298": "法罗群岛" },
    { "+679": "斐济" },
    { "+358": "芬兰" },
    { "+33": "法国" },
    { "+594": "法属圭亚那" },
    { "+689": "法属玻利尼西亚" },
    { "+241": "加蓬" },
    { "+220": "冈比亚" },
    { "+995": "格鲁吉亚" },
    { "+49": "德国" },
    { "+233": "加纳" },
    { "+350": "直布罗陀" },
    { "+30": "希腊" },
    { "+299": "格陵兰" },
    { "+1473": "格林纳达" },
    { "+590": "瓜德罗普岛" },
    { "+1671": "关岛" },
    { "+502": "危地马拉" },
    { "+240": "几内亚" },
    { "+44": "根西岛" },
    { "+224": "几内亚" },
    { "+592": "圭亚那" },
    { "+509": "海地" },
    { "+504": "洪都拉斯" },
    { "+852": "中国香港" },
    { "+95": "缅甸" },
    { "+36": "匈牙利" },
    { "+354": "冰岛" },
    { "+91": "印度" },
    { "+62": "印度尼西亚" },
    { "+98": "伊朗" },
    { "+964": "伊拉克共和国" },
    { "+353": "爱尔兰" },
    { "+44": "马恩岛" },
    { "+972": "以色列" },
    { "+39": "意大利" },
    { "+1876": "牙买加" },
    { "+81": "日本" },
    { "+44": "泽西岛" },
    { "+962": "约旦" },
    { "+7": "哈萨克斯坦共和国" },
    { "+254": "肯尼亚" },
    { "+383": "科索沃" },
    { "+965": "科威特" },
    { "+996": "吉尔吉斯坦" },
    { "+856": "老挝" },
    { "+371": "拉脱维亚" },
    { "+961": "黎巴嫩" },
    { "+266": "莱索托" },
    { "+231": "利比里亚" },
    { "+218": "利比亚" },
    { "+423": "列支敦士登" },
    { "+370": "立陶宛" },
    { "+352": "卢森堡" },
    { "+853": "中国澳门" },
    { "+389": "马其顿共和国" },
    { "+261": "马达加斯加" },
    { "+265": "马拉维" },
    { "+60": "马来西亚" },
    { "+960": "马尔代夫" },
    { "+223": "马里" },
    { "+356": "马耳他" },
    { "+596": "马提尼克" },
    { "+222": "毛利塔尼亚" },
    { "+230": "毛里求斯" },
    { "+262": "马约特岛" },
    { "+52": "墨西哥" },
    { "+373": "摩尔多瓦" },
    { "+377": "摩纳哥" },
    { "+976": "蒙古" },
    { "+382": "黑山共和国" },
    { "+1664": "蒙特塞拉特岛" },
    { "+212": "摩洛哥" },
    { "+258": "莫桑比克" },
    { "+264": "纳米比亚" },
    { "+977": "尼泊尔" },
    { "+31": "荷兰" },
    { "+599": "荷属安的列斯" },
    { "+687": "新喀里多尼亚" },
    { "+64": "新西兰" },
    { "+505": "尼加拉瓜" },
    { "+227": "尼日尔" },
    { "+234": "尼日利亚" },
    { "+47": "挪威" },
    { "+968": "阿曼" },
    { "+92": "巴基斯坦" },
    { "+970": "巴勒斯坦" },
    { "+507": "巴拿马" },
    { "+675": "巴布亚新几内亚" },
    { "+595": "巴拉圭" },
    { "+51": "秘鲁" },
    { "+63": "菲律宾" },
    { "+48": "波兰" },
    { "+351": "葡萄牙" },
    { "+1": "波多黎各" },
    { "+974": "卡塔尔" },
    { "+262": "留尼旺" },
    { "+40": "罗马尼亚" },
    { "+7": "俄罗斯" },
    { "+250": "卢旺达" },
    { "+684": "东萨摩亚(美)" },
    { "+685": "西萨摩亚" },
    { "+378": "圣马力诺" },
    { "+239": "圣多美和普林西比" },
    { "+966": "沙特阿拉伯" },
    { "+221": "塞内加尔" },
    { "+381": "塞尔维亚" },
    { "+248": "塞舌尔" },
    { "+232": "塞拉利昂" },
    { "+65": "新加坡" },
    { "+421": "斯洛伐克" },
    { "+386": "斯洛文尼亚" },
    { "+27": "南非" },
    { "+82": "韩国" },
    { "+34": "西班牙" },
    { "+94": "斯里兰卡" },
    { "+1869": "圣基茨和尼维斯" },
    { "+1758": "圣卢西亚" },
    { "+1784": "圣文森特" },
    { "+249": "苏丹" },
    { "+597": "苏里南" },
    { "+268": "斯威士兰" },
    { "+46": "瑞典" },
    { "+41": "瑞士" },
    { "+963": "叙利亚" },
    { "+886": "中国台湾" },
    { "+992": "塔吉克斯坦" },
    { "+255": "坦桑尼亚" },
    { "+66": "泰国" },
    { "+670": "东帝汶" },
    { "+228": "多哥" },
    { "+676": "汤加" },
    { "+1868": "特立尼达和多巴哥" },
    { "+216": "突尼斯" },
    { "+90": "土耳其" },
    { "+993": "土库曼斯坦" },
    { "+1649": "特克斯和凯科斯群岛" },
    { "+256": "乌干达" },
    { "+380": "乌克兰" },
    { "+971": "阿拉伯联合酋长国" },
    { "+44": "英国" },
    { "+1": "美国" },
    { "+598": "乌拉圭" },
    { "+998": "乌兹别克斯坦" },
    { "+678": "瓦努阿图" },
    { "+58": "委内瑞拉" },
    { "+84": "越南" },
    { "+1340": "维尔克群岛" },
    { "+967": "也门" },
    { "+260": "赞比亚" },
    { "+263": "津巴布韦" }
]
```

URL：/v2/user/register

请求方法：POST

认证参数：Sign

请求参数：

| **名称**         | **类型** | **允许为空** | **说明**                                                                                                   |
| :--------------- | :------- | :----------- | :--------------------------------------------------------------------------------------------------------- |
| countryCode      | String   | N            | 电话区号区号，必须以"+"开头，比如"+86"                                                                     |
| email            | String   | Y            | 邮箱地址，不区分大小写（系统自动存小写）                                                                   |
| phoneNumber      | String   | Y            | 手机号 （优先检查） 以电话区号开头，比如"+8618023456789" email 和 phoneNumber 必须二选一填写一个，否则报错 |
| verificationCode | String   | N            | 短信/邮箱验证码                                                                                            |
| password         | String   | N            | 密码                                                                                                       |

响应 data 参数:

| **名称** | **类型** | **允许为空** | **说明**                                             |
| :------- | :------- | :----------- | :--------------------------------------------------- |
| user     | Object   | N            | 用户信息                                             |
| at       | String   | N            | Access Token                                         |
| rt       | String   | N            | Refresh Token                                        |
| region   |  String  | N            | 用户所属区域 cn=中国区 as=亚洲区 us=美洲区 eu=欧洲区 |

user 说明:

| **名称**       | **类型** | **允许为空** | **说明**                                                                                                                                                                                                                                             |
| :------------- | :------- | :----------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| countryCode    | String   | Y            | 电话区号区号，以"+"开头，比如"+86"                                                                                                                                                                                                                   |
| phoneNumber    | String   | Y            | 用户手机号，带电话区号格式:+8615815725225                                                                                                                                                                                                            |
| email          | String   | Y            | 用户邮箱 用户手机和邮箱不会同时为空                                                                                                                                                                                                                  |
| apikey         | String   | N            | 用户 id                                                                                                                                                                                                                                              |
| nickname       | String   | Y            | 用户昵称                                                                                                                                                                                                                                             |
| wxServiceId    | String   | Y            | 绑定的微信服务号 ID                                                                                                                                                                                                                                  |
| wxAppId        | String   | Y            | 微信服务号 appID                                                                                                                                                                                                                                     |
| wxId           | String   | Y            | 微信用户 ID                                                                                                                                                                                                                                          |
| wxOpenId       | String   | Y            | 微信用户 OpenID                                                                                                                                                                                                                                      |
| yanKanYunInfo  | Object   | Y            | 遥看云账号信息                                                                                                                                                                                                                                       |
| accountLevel   | Int      | N            | 账号等级 10=Free 20=Advanced 30=Pro                                                                                                                                                                                                                  |
| levelExpiredAt | Long     | Y            | 会员等级到期时间戳，精确到毫秒，如果字段为空或 0，表示没有过期时间                                                                                                                                                                                   |
| denyRecharge   | Boolean  | Y            | 当前的账号是否已经无法充值会员，字段为空或者值为 false，代表可以充值，值为 true，代表禁止充值                                                                                                                                                        |
| accountConsult | Boolean  | Y            | 是否接受过会员咨询反馈                                                                                                                                                                                                                               |
| ipCountry      | String   | Y            | 后台根据接口调用 ip 算出的用户所在国家和地区，国家地区码参见 [这里](https://en.wikipedia.org/wiki/List_of_ISO_3166_country_codes)（需翻墙）的 Alpha-2 code 说明。请求 "获取用户信息" 或 “首页” 接口（带上 getUser 参数）时，服务端就会返回这个字段。 |

错误响应参见登录接口

### 账号登录

URL：/v2/user/login

请求方法：POST

认证参数：Sign

请求参数：

| **名称**    | **类型** | **允许为空** | **说明**                                                                                                   |
| :---------- | :------- | :----------- | :--------------------------------------------------------------------------------------------------------- |
| lang        | String   | Y            | cn 返回中文信息，en 返回英文信息，默认 en                                                                  |
| countryCode | String   | N            | 电话区号区号，必须以"+"开头，比如"+86"                                                                     |
| email       | String   | Y            | 邮箱地址，不区分大小写                                                                                     |
| phoneNumber | String   | Y            | 手机号 （优先检查） 以电话区号开头，比如“+8618023456789” email 和 phoneNumber 必须二选一填写一个，否则报错 |
| password    | String   | N            | 密码                                                                                                       |

响应 data 参数:

| **名称** | **类型** | **允许为空** | **说明**                                             |
| :------- | :------- | :----------- | :--------------------------------------------------- |
| user     | Object   | N            | 用户信息，参见【注册】接口                           |
| at       | String   | N            | Access Token                                         |
| rt       | String   | N            | Refresh Token                                        |
| region   |  String  | N            | 用户所属区域 cn=中国区 as=亚洲区 us=美洲区 eu=欧洲区 |

当 error 为 10004 时，表示账号不在当前区域，客户端需要根据返回的区域信息重新去其它区调用登录接口。返回数据举例如下:

```json
{
  "error": 10004,
  "msg": "redirection",
  "data": { "region": "eu" }
}
```

### 使用短信验证码登录

URL：/v2/user/sms-login

请求方法：POST

认证参数：Sign

说明:

**此接口目前仅限中国区手机号**

请求参数：

| **名称**         | **类型** | **允许为空** | **说明**                                    |
| :--------------- | :------- | :----------- | :------------------------------------------ |
| countryCode      | String   | N            | 电话区号区号，必须以"+"开头，比如"+86"      |
| lang             | String   | Y            | cn 返回中文信息，en 返回英文信息，默认 en   |
| phoneNumber      | String   | N            | 手机号 以电话区号开头，比如“+8618023456789” |
| verificationCode | String   | N            | 短信验证码                                  |

响应 data 参数:

| **名称** | **类型** | **允许为空** | **说明**                                                 |
| :------- | :------- | :----------- | :------------------------------------------------------- |
| user     | Object   | N            | 用户信息，参见【注册】接口                               |
| at       | String   | N            | Access Token                                             |
| rt       | String   | N            | Refresh Token                                            |
| region   | String   | N            | 用户所属区域代码 cn=中国区 as=亚洲区 us=美洲区 eu=欧洲区 |

错误响应参见登录接口

### 发送验证码

URL：/v2/user/verification-code

认证参数：Sign

请求方法：POST

说明：对同一个邮箱或者手机号，有发送频次限制如下:

- 1 分钟内不能超过 3 次
- 1 小时内不能超过 20 次
- 1 天内不能超过 100 次

请求参数：

| **名称**    | **类型** | **允许为空** | **说明**                                                                                             |
| :---------- | :------- | :----------- | :--------------------------------------------------------------------------------------------------- |
| type        | Int      | N            | 验证码类型 0: 注册 1: 重置密码 3: 注销账号 4: 验证码登录                                             |
| email       | String   | Y            | 发送的邮箱地址，区分大小写                                                                           |
| phoneNumber | String   | Y            | 发送的手机号，以电话区号开头，比如“+8618023456789” email 和 phoneNumber 必须二选一填写一个，否则报错 |

当 error 为 10004 时，表示账号不在当前区域，客户端需要根据返回的区域信息重新去其它区调用登录接口。返回数据举例如下：

```json
{
  "error": 10004,
  "msg": "redirection",
  "data": { "region": "eu" }
}
```

响应 data 参数: 无

### 重置密码

URL：/v2/user/reset-pwd

说明：用户如果忘记密码，可以使用该接口重新设置密码

请求方法：POST

认证参数：Sign

请求参数：

| **名称**         | **类型** | **允许为空** | **说明**                                                                                       |
| :--------------- | :------- | :----------- | :--------------------------------------------------------------------------------------------- |
| email            | String   | Y            | 邮箱地址，不区分大小写                                                                         |
| phoneNumber      | String   | Y            | 手机号，以电话区号开头，比如“+8618023456789” email 和 phoneNumber 必须二选一填写一个，否则报错 |
| verificationCode | String   | N            | 验证码                                                                                         |
| password         | String   | N            | 密码                                                                                           |

响应 data 参数:

| **名称** | **类型** | **允许为空** | **说明**                                             |
| :------- | :------- | :----------- | :--------------------------------------------------- |
| user     | Object   | N            | 用户信息，参见【注册】接口                           |
| at       | String   | N            | Access Token                                         |
| rt       | String   | N            | Refresh Token                                        |
| region   |  String  | N            | 用户所属区域 cn=中国区 as=亚洲区 us=美洲区 eu=欧洲区 |

### 修改密码

URL：/v2/user/change-pwd

请求方法：POST

认证参数：accessToken

请求参数：

| **名称**    | **类型** | **允许为空** | **说明** |
| :---------- | :------- | :----------- | :------- |
| oldPassword | String   | N            | 原密码   |
| newPassword | String   | N            | 新密码   |

响应 data 参数: 无

### 获取用户信息

URL：/v2/user/profile

请求方法：GET

认证参数：accessToken

请求参数：

无

响应 data 参数:

| **名称** | **类型** | **允许为空** | **说明**                                             |
| :------- | :------- | :----------- | :--------------------------------------------------- |
| user     | Object   | N            | 用户信息，参见【注册】接口                           |
| region   |  String  | N            | 用户所属区域 cn=中国区 as=亚洲区 us=美洲区 eu=欧洲区 |

### 更新用户信息

URL：/v2/user/profile

请求方法：POST

认证参数：accessToken

请求参数：

| **名称**       | **类型** | **允许为空** | **说明**                                                                                     |
| :------------- | :------- | :----------- | :------------------------------------------------------------------------------------------- |
| nickname       | String   | Y            | 要更新的用户昵称,如果字段为空或 NULL，表示不更新昵称                                         |
| acceptEmailAd  | Boolean  | Y            | 是否接受邮件订阅广告,如果字段为空或 NULL，表示不更新                                         |
| accountConsult | Boolean  | Y            | 是否接受过会员咨询反馈,固定值 true，填写其它值则返回参数错误,如果字段为空或 NULL，表示不更新 |

响应 data 参数: 无

### 刷新认证 token

URL：/v2/user/refresh

请求方法：POST

认证参数：accessToken 或者签名

说明：Access Token 缺省 30 天失效（安全原因），此时可以不用重新登录获取 Access Token，而是使用 Refresh Token 刷新获取 Access Token

请求参数：

| **名称** | **类型** | **允许为空** | **说明**      |
| :------- | :------- | :----------- | :------------ |
| rt       | String   | N            | Refresh Token |

响应 data 参数:

| **名称** | **类型** | **允许为空** | **说明**      |
| :------- | :------- | :----------- | :------------ |
| at       | String   | N            | Access Token  |
| rt       | String   | N            | Refresh Token |

### 退出登录

URL：/v2/user/logout

请求方法：DELETE

认证参数：accessToken

请求参数：无

响应 data 参数：无

### 注销账号

URL：/v2/user/close-account

请求方法：POST

认证参数：accessToken

请求参数：

| **名称**         | **类型** | **允许为空** | **说明** |
| :--------------- | :------- | :----------- | :------- |
| verificationCode | String   | N            | 验证码   |

响应 data 参数: 无

## 首页

### 获取首页信息

**注意：**

- 当用户设备（total 参数）超过 30，需要设置 beginIndex 参数分页获取，否则获取数据过多，服务端会返回 500 等超时错误。
- 返回的 total 参数可能大于返回的设备数据总额，说明未获取到所有设备数据，具体原因是：目前我们只授权了松诺和酷宅的品牌，其他厂商的品牌需要在我们业务同事的帮助下签订授权书才能使用，详见「接口中心\_v2->调用规范（重要）」章节。

URL：/v2/homepage

请求方法：POST

认证参数：accessToken

请求参数：

| **名称**   | **类型** | **允许为空** | **说明**                                                                |
| :--------- | :------- | :----------- | :---------------------------------------------------------------------- |
| lang       | String   | Y            | cn 返回中文信息，en 返回英文信息，默认 en                               |
| clientInfo | Object   | Y            | 客户端信息                                                              |
| getUser    | Object   | Y            | 如果要获取用户信息，则填写此字段                                        |
| getFamily  | Object   | Y            | 如果要获取家庭信息，则填写此字段 将会得到所有家庭的信息                 |
| getThing   | Object   | Y            | 如果要获取 Thing 信息，则填写此字段 只会取得当前家庭下的 Thing 信息     |
| getScene   | Object   | Y            | 场景列表，暂未开放                                                      |
| getMessage | Object   | Y            | 如果要获取消息中心的通知信息，则填写此字段 只会取得当前家庭下的通知信息 |

clientInfo 说明:

| **名称**   | **类型** | **允许为空** | **说明**                       |
| :--------- | :------- | :----------- | :----------------------------- |
| model      | String   | Y            | 手机型号，比如 "M6 Note"       |
| os         | String   | Y            | 操作系统，值为"Android"或"iOs" |
| imei       | String   | Y            | 手机 IMEI 号                   |
| romVersion | String   | Y            | 手机的 android/ios 系统版本号  |
| appVersion | String   | Y            | App 版本                       |

getThing 说明:

| **名称**   | **类型** | **允许为空** | **说明**                                         |
| :--------- | :------- | :----------- | :----------------------------------------------- |
| num        | Int      | Y            | 获取的数量，不填则默认为 30 0 表示获取所有       |
| beginIndex | Int      | Y            | 从哪个序号开始获取列表数据，不填则默认为-9999999 |

getMessage 说明:

| **名称** | **类型** | **允许为空** | **说明**                                                                         |
| :------- | :------- | :----------- | :------------------------------------------------------------------------------- |
| from     | Long     | Y            | 时间戳，精确到毫秒，表示从什么时间开始，获取更早之前的消息，不填则默认为当前时间 |
| num      | Int      | Y            | 最多拉取的消息数量，1<= num <= 30，不填则默认为 30                               |

响应 data 参数:

| **名称**    | **类型** | **允许为空** | **说明**                                         |
| :---------- | :------- | :----------- | :----------------------------------------------- |
| userInfo    | Object   | Y            | 参见【注册】接口中的 user 说明                   |
| familyInfo  | Object   | Y            | 参见【获取家庭和房间列表】接口中的 data 响应说明 |
| thingInfo   | Object   | Y            | 参见【获取 Thing 列表】接口中的 data 响应说明    |
| sceneInfo   | Object   | Y            | 参见【获取场景列表】接口中的 data 响应说明       |
| messageInfo | Object   | Y            | 参见【获取通知消息列表】接口中的 data 响应说明   |

客户端调用示例：

```json
{
  "lang": "cn",
  "clientInfo": {
    "model": "xxx"
  },
  "getUser": {},
  "getFamily": {},
  "getThing": {
    "num": 10
  },
  "getScene": {},

  "getMessage": {}
}
```

## 设备  

### 获取全部设备列表（请查阅获取 Tings 列表、获取指定 Tings 列表和首页接口）

URL：无

请求方法：get

认证参数：accessToken

请求参数：无

响应 data 参数：

| **名称**   | **类型**        | **允许空** | **说明** |
| :--------- | :-------------- | :--------- | :------- |
| deviceList | Array\<Object\> | N          | 设备列表 |

deviceList 列表 item 说明：

| **名称**     | **类型**        | **允许空** | **说明**                                                  |
| :----------- | :-------------- | :--------- | :-------------------------------------------------------- |
| name         | String          | N          | 设备名称                                                  |
| deviceid     | String          | N          | 设备 ID                                                   |
| apikey       | String          | N          | 设备所属用户的 apikey                                     |
| extra        | Object          | N          | factoryDevice 的 extra 字段中的内容                       |
| brandName    | String          | N          | 品牌名称                                                  |
| brandLogo    | String          | N          | 品牌 Logo url                                             |
| showBrand    | Boolean         | N          | 是否显示品牌                                              |
| productModel | String          | N          | 产品型号名称                                              |
| devGroups    | Array\<Object\> |  Y         | 设备所属的群组信息列表                                    |
| tags         | Object          | Y          | 标签对象，里面是存储的是自定义字符串，服务器只负责透传    |
| devConfig    | Object          | Y          | 设备端配置信息，来源于 factorydevices 表的 deviceConfig。 |
| settings     | Object          | Y          | 用户设置，参见【修改设备配置】接口说明                    |
| family       | Object          | N          | 设备的家庭设置                                            |
| sharedBy     | Object          | Y          | 如果设备是别人分享过来的，就会有该属性。                  |
| shareTo      | Array\<Object\> | Y          | 被分享用户的列表，表示用户把设备分享给了哪些人。          |
| devicekey    | String          | N          | 设备的出厂 apikey                                         |
| online       | Boolean         | N          | 在线状态                                                  |
| params       | Object          | Y          | 设备的状态属性                                            |
| gsmInfoData  | Object          | Y          | GSM 设备的卡状态对象                                      |

extra 说明：

| **名称**     | **类型** | **允许空** | **说明**                      |
| :----------- | :------- | :--------- | :---------------------------- |
| model        | String   | N          | 固件名称                      |
| ui           | String   | N          | UI 的名称                     |
| uiid         | Int      | N          | UI 的 ID                      |
| description  | String   | N          | 出厂信息备注，一般是订单号    |
| manufacturer | String   | N          | 制造商                        |
| mac          | String   | N          | mac 地址                      |
| apmac        | String   | N          | ap mac 地址（设备热点的地址） |
| modelInfo    | String   | N          | 产品型号 ID                   |
| brandId      | String   | N          | 品牌 ID                       |

settings 说明:

| **名称**    | **类型** | **允许为空** | **说明**                                       |
| :---------- | :------- | :----------- | :--------------------------------------------- |
| opsNotify   | Int      | Y            | 操作变化是否通知用户（默认 0）0=不通知  1=通知 |
| opsHistory  | Int      | Y            | 是否记录操作历史（默认 1）0=不记录  1=记录     |
| alarmNotify | Int      | Y            | 是否发送告警信息（默认 1）0=不发送  1=发送     |

devGroups 说明：

| **名称** | **类型** | **允许空** | **说明**       |
| :------- | :------- | :--------- | :------------- |
| type     | Int      | N          | 1 代表设备群组 |
| groupId  | String   | N          | 所属群组的 id  |

sharedBy 列表 item 说明：

| **名称**    | **类型** | **允许空** | **说明**                                           |
| :---------- | :------- | :--------- | :------------------------------------------------- |
| apikey      | String   | N          | 设备所属用户的唯一标识（目前使用对称加密该字符串） |
| permit      | Int      | N          | 用户的权限值，默认为 0                             |
| phoneNumber | String   | Y          | 设备所属用户手机号                                 |
| email       | String   | Y          | 设备所属用户 email                                 |
| nickname    | String   | Y          | 设备所属用户的昵称                                 |
| comment     | String   | Y          | 分享时的备注                                       |
| shareTime   | Long     | Y          | GMT 标准时间，毫秒数，主要用来在客户端显示排序。   |

shareTo 列表 item 说明：

| **名称**    | **类型** | **允许空** | **说明**                                                   |
| :---------- | :------- | :--------- | :--------------------------------------------------------- |
| permit      | Int      | N          | 用户的权限值，默认为 0                                     |
| apikey      | String   | N          | 接收设备分享的用户账号 ID 标识（目前使用对称加密该字符串） |
| phoneNumber | String   | Y          | 设备所属用户手机号                                         |
| email       | String   | Y          | 设备所属用户 email                                         |
| nickname    | String   | Y          | 设备所属用户的昵称                                         |
| comment     | String   | Y          | 分享时的备注                                               |
| shareTime   | Long     | Y          | GMT 标准时间，毫秒数，主要用来在客户端显示排序。           |

devConfig 说明（摄像头）：

| **名称**      | **类型** | **允许空** | **说明**   |
| :------------ | :------- | :--------- | :--------- |
| p2pServerName | String   | Y          | 服务器名称 |
| p2pAccout     | String   | Y          | 账号       |
| p2pLicense    | String   | Y          | license    |

family 说明：

| **名称** | **类型** | **允许空** | **说明**                |
| :------- | :------- | :--------- | :---------------------- |
| familyid | String   | N          | 家庭 id                 |
| index    | Int      | N          | 设备排序号 可能存在负数 |
| roomid   | String   | Y          | 所属房间 id             |

### 获取 Thing 列表

**注意：**

- 当用户设备（total 参数）超过 30，需要设置 beginIndex 参数分页获取，否则获取数据过多，服务端会返回 500 等超时错误。
- 返回的 total 参数可能大于返回的设备数据总额，说明未获取到所有设备数据，具体原因是：目前我们只授权了松诺和酷宅的品牌，其他厂商的品牌需要在我们业务同事的帮助下签订授权书才能使用，详见「接口中心\_v2->调用规范（重要）」章节。
- 如果因为业务关系，需要用到多个易微联账号，但没有资源建立多个长连接，建议把其他账号的设备都分享到一个特定易微联账号，然后建立这个账号的长连接，被动接收消息，减少接口调用轮询。

URL：/v2/device/thing

请求方法：GET

认证参数：accessToken

说明：Thing 包括

- 设备（自己的和别人分享的）
- 设备群组

请求参数：

| **名称**   | **类型** | **允许为空** | **说明**                                         |
| :--------- | :------- | :----------- | :----------------------------------------------- |
| lang       | String   | Y            | cn 返回中文信息，en 返回英文信息，默认 en        |
| familyid   | String   | Y            | 家庭 id，不填则默认为当前家庭                    |
| num        | Int      | Y            | 获取的数量，默认为 30，0 表示获取所有            |
| beginIndex | Int      | Y            | 从哪个序号开始获取列表数据，不填则默认为-9999999 |

响应 data 参数:

| **名称**  | **类型** | **允许为空** | **说明**                      |
| :-------- | :------- | :----------- | :---------------------------- |
| thingList | Array    | N            | Thing 列表                    |
| total     | Int      | N            | Thing 总数量（设备+设备群组） |

thingList 列表 item 说明:

| **名称** | **类型** | **允许为空** | **说明**                                                                                                                                                     |
| :------- | :------- | :----------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| itemType | Int      | N            | item 的类型 1=用户自己的设备 2=别人分享的设备 3=自己的群组                                                                                                   |
| itemData | Object   | N            | 根据 itemType 有不同的结构 1 和 2 时参见【获取全部设备列表】接口中的 deviceList 列表 item 说明 3 时参见【获取设备群组列表】接口中的 groupList 列表 item 说明 |
| index    | Int      | N            | 排序号                                                                                                                                                       |

### 获取指定 Thing 列表信息

URL：/v2/device/thing

请求方法：POST

认证参数：accessToken

请求参数：

| **名称**  | **类型** | **允许为空** | **说明**                                             |
| :-------- | :------- | :----------- | :--------------------------------------------------- |
| thingList | Array    | N            | 需要获取的 thing 列表列表数量必须大于 0，小于等于 10 |

thingList item 说明:

| **名称** | **类型** | **允许为空** | **说明**                                                                              |
| :------- | :------- | :----------- | :------------------------------------------------------------------------------------ |
| itemType | Int      | N            | item 的类型 1=用户自己的设备 2=别人分享的设备 3=自己的群组                            |
| id       | String   | N            | thing 对应的 id,itemType 为 1 或 2 时为设备的 deviceid,itemType 为 3 或 4 时为群组 id |

响应 data 参数:

| **名称**  | **类型** | **允许为空** | **说明**                                        |
| :-------- | :------- | :----------- | :---------------------------------------------- |
| thingList | Array    | N            | Thing 列表信息，参见【获取 thing 列表】中的说明 |

### 获取设备或群组的状态

建议使用长连接被动接收设备状态更新。减少轮询，避免频繁请求本接口。

URL：/v2/device/thing/status

请求方法：GET

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                                      |
| :------- | :------- | :----------- | :-------------------------------------------- |
| type     | Int      | N            | 要获取设备还是群组 1=设备 2=群组              |
| id       | String   | N            | type=1 时为设备的 deviceid type=2 时为群组 id |
| params   | String   | Y            | 需要获取的状态参数                            |

**params 说明**

调用方可以指定只获取特定的状态参数，以"|"间隔，再做 URL 转换。

举例: 想要得到 switch 和 light 两个状态

1. 构造字符串 switch|light
2. 对(1)的字符串做 URL 转换，得到字符串 switch%7Clight，即为发送给接口 params 参数的值

如果要获取设备或群组所有的状态，params 参数为空即可

响应 data 参数:

| **名称** | **类型** | **允许为空** | **说明**             |
| :------- | :------- | :----------- | :------------------- |
| params   | Object   | N            | 设备或群组的状态属性 |

### 更新设备或群组的状态

建议使用长连接下发控制指令。

URL：/v2/device/thing/status

请求方法：POST

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                                      |
| :------- | :------- | :----------- | :-------------------------------------------- |
| type     | Int      | N            | 要更新设备还是群组 1=设备 2=群组              |
| id       | String   | N            | type=1 时为设备的 deviceid type=2 时为群组 id |
| params   | Object   | N            | 更新的状态参数                                |

**params 说明**

- 更新设备时，会向设备下发控制指令，如果设备不在线或发送失败，会返回错误
- 更新群组时，会向群组下的所有设备发送控制指令，并忽略设备不在线或发送失败的情况

响应 data 参数: 无

### 批量更新设备或群组的状态

说明：该接口会实际向设备下发控制指令，是为不能走长连接更新状态的设备准备的

URL：/v2/device/thing/batch-status

请求方法：POST

认证参数：accessToken

请求参数：

| **名称**  | **类型**        | **允许为空** | **说明**                                                                                   |
| :-------- | :-------------- | :----------- | :----------------------------------------------------------------------------------------- |
| thingList | Array\<Object\> | N            | 要更新的 thing 列表，长度大于 0，小于等于 10，客户端需保证列表中的 id 是唯一的，否则报错   |
| timeout   | Int             | Y            | 等待所有设备响应的时间，单位毫秒， 0 <= timeout <= 8000 ，如果不填则默认为 0，表示立即返回 |

thingList 列表中 item 的说明:

| **名称** | **类型** | **允许为空** | **说明**                                       |
| :------- | :------- | :----------- | :--------------------------------------------- |
| type     | Int      | N            | 要更新设备还是群组，1=设备 2=群组              |
| id       | String   | N            | type=1 时为设备的 deviceid，type=2 时为群组 id |
| params   | Object   | N            | 要更新的状态参数                               |

响应 data 参数：

| **名称** | **类型**        | **允许为空** | **说明**                  |
| :------- | :-------------- | :----------- | :------------------------ |
| respList | Array\<Object\> | N            | 每个 thing 的响应结果列表 |

respList 列表中 item 的说明:

| **名称** | **类型** | **允许为空** | **说明**                                                                                          |
| :------- | :------- | :----------- | :------------------------------------------------------------------------------------------------ |
| type     | Int      | N            | 要更新设备还是群组，1=设备 2=群组                                                                 |
| id       | String   | N            | type=1 时为设备的 deviceid，type=2 时为群组 id                                                    |
| error    | Int      | N            | 响应错误码，0 代表无错误如果 type=2，则 error 固定为 0 如果调用时 timeout 为 0，则 error 固定为 0 |

### 添加 WiFi 设备

URL：/v2/device/add

请求方法：POST

认证参数：accessToken

说明：新增普通的 WiFi 设备

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                                                             |
| :------- | :------- | :----------- | :------------------------------------------------------------------- |
| name     | String   | N            | 设备名称                                                             |
| deviceid | String   | N            | 设备 id                                                              |
| settings | Object   | Y            | 用户设置 如果没有则采用默认值                                        |
| ifrCode  | String   | Y            | 红外设备的码值                                                       |
| digest   | String   | N            | Hash SHA256(deviceid+设备 apikey) 小写字符串                         |
| chipid   | String   | N            | 设备的芯片 id                                                        |
| familyid | String   | Y            | 设备所属的家庭 id，如果为空，表示添加到当前家庭                      |
| roomid   | String   | Y            | 设备所属的房间 id，如果为空，表示添加到【未分配】下                  |
| sort     | Int      | Y            | 给新设备分配序号的方式，如果为空则默认为 1 1=更小的序号 2=更大的序号 |

digest 算法：

比如：123

Hash SHA256 结果：a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3

settings 说明:

| **名称**    | **类型** | **允许为空** | **说明**                                       |
| :---------- | :------- | :----------- | :--------------------------------------------- |
| opsNotify   | Int      | Y            | 操作变化是否通知用户（默认 0）0=不通知  1=通知 |
| opsHistory  | Int      | Y            | 是否记录操作历史（默认 1）0=不记录  1=记录     |
| alarmNotify | Int      | Y            | 是否发送告警信息（默认 1）0=不发送  1=发送     |

响应 data 参数:

| **名称** | **类型** | **允许为空** | **说明**                                                   |
| :------- | :------- | :----------- | :--------------------------------------------------------- |
| itemType | Int      | N            | item 的类型，这里固定为 1                                  |
| itemData | Object   | N            | 参见【获取全部设备列表】接口中的 deviceList 列表 item 说明 |
| index    | Int      | N            | 排序号                                                     |

说明：如果报 30017 错误，原因是设备所属的品牌并没有授权给你的 APPID，目前酷宅自有品牌是免费授权的，但其他厂商的品牌会保留使用权限，授权相关的问题可在微信对接群咨询我司市场部销售人员。

```json
{
  "error": 30017,
  "msg": "this app does not support of adding this brand and its device",
  "data": {}
}
```

### 新增 GSM 设备

URL：/v2/device/add-gsm

请求方法：POST

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                                                                                                                                                       |
| :------- | :------- | :----------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| id       | String   | N            | 从扫描设备上的二维码 URL 中获取设备 gsmId，URL 格式： https://api.coolkit.cc:8080/api/user/device/addGsm?id=348512d49379bb0acace4598e14fc450，id是后面那个参数 |
| name     | String   | N            | 设备名称                                                                                                                                                       |
| familyid | String   | Y            | 设备所属的家庭 id，如果为空，表示添加到当前家庭                                                                                                                |
| roomid   | String   | Y            | 设备所属的房间 id，如果为空，表示添加到【未分配】下                                                                                                            |
| sort     | Int      | Y            | 给新设备分配序号的方式，如果为空则默认为 1 1=更小的序号 2=更大的序                                                                                             |

备注：应用扫描设备上的二维码可以获取到一个 URL 格式的字符串，请注意域名是有可能改变的，但 "/addGsm?id={gsmId}" 不会改变。

响应 data 参数:

| **名称** | **类型** | **允许为空** | **说明**                                                   |
| :------- | :------- | :----------- | :--------------------------------------------------------- |
| itemType | Int      | N            | item 的类型，这里固定为 1                                  |
| itemData | Object   | N            | 参见【获取全部设备列表】接口中的 deviceList 列表 item 说明 |
| index    | Int      | N            | 排序号                                                     |

响应 data 参数:

| **名称**  | **类型** | **允许为空** | **说明**                                                                        |
| :-------- | :------- | :----------- | :------------------------------------------------------------------------------ |
| thingList | Array    | N            | 成功添加的设备列表 由于添加第三方设备时，可能一次添加多个设备，所以这里返回列表 |

thingList 列表中 item 的说明:

| **名称** | **类型** | **允许为空** | **说明**                                                   |
| :------- | :------- | :----------- | :--------------------------------------------------------- |
| itemType | Int      | N            | item 的类型，这里固定为 1                                  |
| itemData | Object   | N            | 参见【获取全部设备列表】接口中的 deviceList 列表 item 说明 |
| index    | Int      | N            | 排序号                                                     |

### 更新设备的名称/房间信息

URL：/v2/device/update-info

请求方法：POST

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明** |
| :------- | :------- | :----------- | :------- |
| deviceid | String   | N            | 设备 id  |
| name     | String   | Y            | 设备名称 |
| roomid   | String   | Y            | 房间 id  |

响应 data 参数: 无

### 删除设备

说明：删除其他人分享给自己的设备也是通过此接口删除的

URL：/v2/device

请求方法：DELETE

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**        |
| :------- | :------- | :----------- | :-------------- |
| deviceid | String   | N            | 要删除的设备 ID |

响应 data 参数: 无

### 修改设备标签

可修改子通道名称，可按照自己想法实现一些特定功能

URL：/v2/device/tags

请求方法：POST

认证参数：accessToken

说明：需要将完整的 tags 对象传过来，服务端整体覆盖原有的值

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                                                 |
| :------- | :------- | :----------- | :------------------------------------------------------- |
| deviceid | String   | N            | 设备 id                                                  |
| type     | String   | Y            | 修改类型，不填则默认为 replace，replace=覆盖，merge=合并 |
| tags     | Object   | N            | 设备标签                                                 |

说明：假设设备原有标签为

```json
{ "key1": "value1", "key2": "value2" }
```

当传入的参数 type=replace，tags 为 {"key3":"value3"}，则更新后的标签为：

```json
{ "key3": "value3" }
```

当传入的参数 type=merge，tags 为 {"key3":"value3"}，则更新后的标签为：

```json
{ "key1": "value1", "key2": "value2", "key3": "value3" }
```

响应 data 参数:

| **名称**     | **类型** | **允许为空** | **说明**            |
| :----------- | :------- | :----------- | :------------------ |
| updatedThing | Object   | N            | 更新后的 thing 数据 |

### 获取设备群组列表

URL：/v2/device/group

请求方法：GET

认证参数：accessToken

说明:

1. 设备群组与设备一同排序
2. 只获取当前家庭下的设备群组列表

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                                  |
| :------- | :------- | :----------- | :---------------------------------------- |
| lang     | String   | Y            | cn 返回中文信息，en 返回英文信息，默认 en |

响应 data 参数:

| **名称**  | **类型** | **允许为空** | **说明** |
| :-------- | :------- | :----------- | :------- |
| groupList | Array    | N            | 群组列表 |

groupList 列表 item 说明:

| **名称** | **类型** | **允许为空** | **说明**                  |
| :------- | :------- | :----------- | :------------------------ |
| itemType | Int      | N            | item 的类型，这里固定为 3 |
| itemData | Object   | N            | 群组的信息                |
| index    | Int      | N            | 排序号                    |

itemData 说明:

| **名称**     | **类型** | **允许为空** | **说明**        |
| :----------- | :------- | :----------- | :-------------- |
| id           | String   | N            | 群组 id         |
| name         | String   | N            | 群组名称        |
| mainDeviceId | String   | N            | 群组的主设备 id |
| family       | Object   | N            | 群组的家庭设置  |
| params       | Object   | N            | 群组状态        |

family 说明:

| **名称** | **类型** | **允许为空** | **说明**                |
| :------- | :------- | :----------- | :---------------------- |
| familyid | String   | N            | 家庭 id                 |
| index    | Int      | N            | 群组排序号 可能存在负数 |
| roomid   | String   | Y            | 所属房间 id             |

### 新增设备群组

URL：/v2/device/group

请求方法：POST

认证参数：accessToken

说明：如果使用别人分享的设备作为主设备来新增群组，则当分享撤销时，该群组也会被一并删除

请求参数：

| **名称**     | **类型**        | **允许为空** | **说明**                                                                                                                         |
| :----------- | :-------------- | :----------- | :------------------------------------------------------------------------------------------------------------------------------- |
| name         | String          | N            | 群组名称，限长 50 个字符                                                                                                         |
| mainDeviceId | String          | N            | 群组的主设备 id                                                                                                                  |
| familyid     | String          | Y            | 群组所属的家庭 id，如果为空，表示添加到当前家庭                                                                                  |
| roomid       | String          | Y            | 群组所属的房间 id，如果为空，表示添加到【未分配】下                                                                              |
| sort         | Int             | Y            | 给新群组分配序号的方式 1=更小的序号 2=更大的序号                                                                                 |
| deviceidList | Array\<String\> | Y            | 创建群组时加入到该群组的设备的 id 列表，不需要将主设备 id 传入，如果列表中的设备 uiid 与主设备的不一致，则不会将该设备添加到群组 |

响应 data 参数:

| **名称** | **类型** | **允许为空** | **说明**                                       |
| :------- | :------- | :----------- | :--------------------------------------------- |
| itemType | Int      | N            | item 的类型，这里固定为 3                      |
| itemData | Object   | N            | 参见【获取设备群组列表】接口中的 itemData 说明 |
| index    | Int      | N            | 排序号                                         |

### 修改设备群组

URL：/v2/device/group

请求方法：PUT

认证参数：accessToken

说明：目前此接口只能修改群组的名称

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                       |
| :------- | :------- | :----------- | :----------------------------- |
| id       | String   | N            | 群组 id                        |
| name     | String   | N            | 修改的群组名称，限长 50 个字符 |

响应 data 参数: 无

### 删除设备群组

URL：/v2/device/group

请求方法：DELETE

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明** |
| :------- | :------- | :----------- | :------- |
| id       | String   | N            | 群组 id  |

响应 data 参数: 无

### 更改群组状态

URL：/v2/device/group/status

请求方法：POST

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                           |
| :------- | :------- | :----------- | :--------------------------------- |
| id       | String   | N            | 群组 id                            |
| params   | Object   | N            | 群组状态，接口只保存数据，不做处理 |

响应 data 参数: 无

### 更新设备群组的设备列表

URL：/v2/device/group/update

说明：该接口会根据传入的设备列表，对群组内的设备做全量覆盖

请求方法：POST

认证参数：accessToken

请求参数：

| **名称**     | **类型**        | **允许为空** | **说明**                                                  |
| :----------- | :-------------- | :----------- | :-------------------------------------------------------- |
| id           | String          | N            | 群组 id                                                   |
| deviceidList | Array\<String\> | N            | 设备 id 列表，必须最少包含群组的主设备 deviceid，否则报错 |

响应 data 参数：

| **名称**         | **类型** | **允许为空** | **说明**            |
| :--------------- | :------- | :----------- | :------------------ |
| updatedThingList | Array    | N            | 更新后的 thing 数据 |

### 设备分享

URL：/v2/device/share

请求方法：POST

认证参数：accessToken

请求参数：

| **名称**     | **类型**      | **允许为空** | **说明**                                                                                             |
| :----------- | :------------ | :----------- | :--------------------------------------------------------------------------------------------------- |
| deviceidList | Array<String> | N            | 设备 id 列表                                                                                         |
| user         | Object        | N            | 用户信息                                                                                             |
| permit       | Int           | N            | 权限值之和，采用位移操作计算，权限值定义：1：新增定时器；2：修改定时器；4：删除定时器；8：启用定时器 |
| comment      | String        | Y            | 分享备注                                                                                             |
| shareType    | Int           | Y            | 分享方式，不填则默认为 1，1=静默分享，不需要被分享的用户同意                                         |

user 说明：

| **名称**    | **类型** | **允许为空** | **说明**                                                    |
| :---------- | :------- | :----------- | :---------------------------------------------------------- |
| countryCode | String   | Y            | 电话区号区号，phoneNumber 不为空时必须填写                  |
| phoneNumber | String   | Y            | 用户手机号码，必须以国家区号开头，比如"+86"                 |
| email       | String   | Y            | 用户 email，手机号码和 email 不能同时为空，优先检查手机号码 |

响应 data 参数:

| **名称**         | **类型** | **允许为空** | **说明**                                                                            |
| :--------------- | :------- | :----------- | :---------------------------------------------------------------------------------- |
| updatedThingList | Array    | N            | 更新后的 thing 数据，参见【新增设备】接口的 data 响应说明，里面包含了分享用户的信息 |

备注: post /v2/device/share 会返回对方的 apikey 参数，可以记下来，在 post /v2/device/share/permit 和 delete /v2/device/share 会用到。

### 修改设备分享的权限

URL：/v2/device/share/permit

请求方法：POST

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                                                   |
| :------- | :------- | :----------- | :--------------------------------------------------------- |
| deviceid | String   | N            | 设备 id                                                    |
| apikey   | String   | N            | 接收设备分享的用户账号 ID 标识（目前使用对称加密该字符串） |
| permit   | Int      | N            | 修改的权限，参见【设备分享】接口参数的说明                 |

Note: apikey 参数来自于设备的详情信息，请在文档中搜索 shareTo 这个参数。

响应 data 参数:

| **名称**     | **类型** | **允许为空** | **说明**                                                                            |
| :----------- | :------- | :----------- | :---------------------------------------------------------------------------------- |
| updatedThing | Array    | N            | 更新后的 thing 数据，参见【新增设备】接口的 data 响应说明，里面包含了分享用户的信息 |

### 取消设备分享

URL：/v2/device/share

请求方法：DELETE

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                    |
| :------- | :------- | :----------- | :-------------------------- |
| deviceid | String   | N            | 设备 id                     |
| apikey   | String   | N            | 要修改分享权限的用户 apikey |

响应 data 参数:

| **名称**     | **类型** | **允许为空** | **说明**                                                                            |
| :----------- | :------- | :----------- | :---------------------------------------------------------------------------------- |
| updatedThing | Array    | N            | 更新后的 thing 数据，参见【新增设备】接口的 data 响应说明，里面包含了分享用户的信息 |

### 获取设备的操作历史记录

URL：/v2/device/history

请求方法：GET

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                                                                         |
| :------- | :------- | :----------- | :------------------------------------------------------------------------------- |
| deviceid | String   | N            | 设备 id                                                                          |
| from     | Long     | Y            | 时间戳，精确到毫秒，表示从什么时间开始，获取更早之前的消息，不填则默认为当前时间 |
| num      | Int      | Y            | 最多拉取的消息数量，1<= num <= 30，不填则默认为 30                               |

响应 data 参数:

| **名称**  | **类型** | **允许为空** | **说明**     |
| :-------- | :------- | :----------- | :----------- |
| histories | Array    | N            | 历史记录列表 |

histories item 说明:

| **名称**   | **类型** | **允许为空** | **说明**                                                      |
| :--------- | :------- | :----------- | :------------------------------------------------------------ |
| deviceid   | String   | N            | 设备 id                                                       |
| userAgent  | String   | Y            | 用户区分是设备端还是 app 端的操作                             |
| opsSwitchs | String   | Y            | 记录被操作的通道值。如果是单通道就只有 1 个元素，值为"switch" |
| request    | String   | N            | 原始的 request 请求                                           |
| opsAccount | String   | Y            | 如果是 app 端的操作，返回操作人的账号（有可能是分享用户的）   |
| opsTime    | Long     | N            | 操作时间戳，精确到毫秒                                        |

### 清除设备的操作历史记录

URL：/v2/device/history

请求方法：DELETE

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明** |
| :------- | :------- | :----------- | :------- |
| deviceid | String   | N            | 设备 id  |

响应 data 参数: 无

### 查询设备的 OTA 信息

URL：/v2/device/ota/query

请求方法：POST

认证参数：accessToken

请求参数：

| **名称**       | **类型**        | **允许为空** | **说明**                                          |
| :------------- | :-------------- | :----------- | :------------------------------------------------ |
| deviceInfoList | Array\<Object\> | N            | 要查询的设备信息列表，列表长度大于 0，小于等于 30 |

deviceInfoList 列表 item 说明：

| **名称** | **类型** | **允许为空** | **说明**             |
| :------- | :------- | :----------- | :------------------- |
| deviceid | String   | N            | 设备 id              |
| model    | String   | N            | 设备的模块型号       |
| version  | String   | N            | 当前设备的固件版本号 |

响应 data 参数：

| **名称**    | **类型**        | **允许为空** | **说明**                                             |
| :---------- | :-------------- | :----------- | :--------------------------------------------------- |
| otaInfoList | Array\<Object\> | N            | OTA 信息列表，如果设备有升级的信息，则会在这个列表中 |

otaInfoList 列表 item 说明：

| **名称**  | **类型**        | **允许为空** | **说明**            |
| :-------- | :-------------- | :----------- | :------------------ |
| deviceid  | String          | N            | 设备 id             |
| version   | String          | N            | 最新的固件版本号    |
| binList   | Array\<Object\> | N            | 不同分区的 bin 列表 |
| type      | String          | N            | （保留字段）        |
| forceTime | String          | N            | （保留字段）        |

binList 列表 item 说明：

| **名称**    | **类型** | **允许为空** | **说明**                 |
| :---------- | :------- | :----------- | :----------------------- |
| name        | String   | N            | 下载文件名称             |
| downloadUrl | String   | N            | 下载地址                 |
| digest      | String   | Y            | 文件 HASH 摘要（SHA256） |

固件升级：

APP 获取到固件信息后，显示可升级提示，用户点击升级，APP 应通过长连接下发 OTA 指令：

```json
{
  "action": "upgrade",
  "deviceid": "设备ID",
  "apikey": "用户APIKEY",
  "userAgent": "app",
  "sequence": "毫秒级时间戳",
  "params": {
    "model": "设备Model",
    "version": "预升级版本号",
    "binList": [
      {
        "downloadUrl": "bin文件1下载地址",
        "digest": "文件 HASH 摘要（SHA256）",
        "name": "user1.bin"
      },
      {
        "downloadUrl": "bin文件2下载地址",
        "digest": "文件 HASH 摘要（SHA256）",
        "name": "user2.bin"
      }
    ]
  }
}
```

设备如果验证正确，会回复（固件版本不同，也有可能不回复而是直接断开连接去 OTA）：

```json
{
  "userAgent": "device",
  "apikey": "用户APIKEY",
  "deviceid": "设备ID",
  "error": 0,
  "sequence": "毫秒级时间戳(与APP发送的一致)"
}
```

这时候 APP 应显示正在升级中（OTA 进度无法确认），并存储此次 OTA 前原版本信息，设备 OTA 升级过程中会重启，重启后设备上报最新固件版本号，APP 收到后与存储的原固件版本对比，大于原固件版本号则判断为升级成功，否则其他情况都应为失败。

## 家庭和房间

### 获取家庭和房间列表

URL：/v2/family

请求方法：GET

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                                  |
| :------- | :------- | :----------- | :---------------------------------------- |
| lang     | String   | Y            | cn 返回中文信息，en 返回英文信息，默认 en |

响应 data 参数:

| **名称**        | **类型** | **允许为空** | **说明**          |
| :-------------- | :------- | :----------- | :---------------- |
| familyList      | Array    | N            | 家庭列表          |
| currentFamilyId | String   | N            | 当前所在家庭的 id |

familyList 列表 item 说明:

| **名称** | **类型** | **允许为空** | **说明**                  |
| :------- | :------- | :----------- | :------------------------ |
| id       | String   | N            | 家庭 id                   |
| apikey   | String   | N            | 用户 apikey               |
| name     | String   | N            | 家庭名称                  |
| index    | Int      | N            | 家庭排序号 可能存在负数   |
| roomList | Array    | Y            | 房间列表                  |

roomList 列表 item 说明:

| **名称** | **类型** | **允许为空** | **说明**                |
| :------- | :------- | :----------- | :---------------------- |
| id       | String   | N            | 房间 id                 |
| name     | String   | N            | 房间名称                |
| index    | Int      | N            | 房间排序号 可能存在负数 |

### 新增家庭

URL：/v2/family

请求方法：POST

认证参数：accessToken

请求参数：

| **名称**     | **类型** | **允许为空** | **说明**                                                |
| :----------- | :------- | :----------- | :------------------------------------------------------ |
| name         | String   | N            | 家庭名称                                                |
| sort         | Int      | N            | 给新家庭分配序号的方式 1=更小的序号 2=更大的序号        |
| roomNameList | Array    | Y            | 房间名称列表 服务端按列表顺序对新创建的房间生成对应序号 |

响应 data 参数:

| **名称** | **类型**        | **允许为空** | **说明**                                         |
| :------- | :-------------- | :----------- | :----------------------------------------------- |
| id       | String          | N            | 家庭 id                                          |
| name     | String          | N            | 家庭名称                                         |
| index    | Int             | N            | 家庭排序号                                       |
| roomList | Array\<Object\> | Y            | 房间列表，参见【获取家庭和房间列表】接口的说明   |

### 新增房间

说明：每个家庭下最多允许有 100 个房间

URL：/v2/family/room

请求方法：POST

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                                         |
| :------- | :------- | :----------- | :----------------------------------------------- |
| familyid | String   | N            | 房间所属的家庭 id                                |
| name     | String   | N            | 房间名称                                         |
| sort     | Int      | N            | 给新房间分配序号的方式 1=更小的序号 2=更大的序号 |

响应 data 参数:

| **名称** | **类型** | **允许为空** | **说明**   |
| :------- | :------- | :----------- | :--------- |
| id       | String   | N            | 房间 id    |
| name     | String   | N            | 房间名称   |
| index    | Int      | N            | 房间排序号 |

### 修改家庭信息

说明：当前只支持修改家庭名称

URL：/v2/family

请求方法：PUT

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                      |
| :------- | :------- | :----------- | :---------------------------- |
| id       | String   | Y            | 家庭 id，不填则为修改当前家庭 |
| name     | String   | N            | 新的家庭名称                  |

响应 data 参数: 无

### 修改房间信息

说明：当前只支持修改房间名称

URL：/v2/family/room

请求方法：PUT

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**     |
| :------- | :------- | :----------- | :----------- |
| id       | String   | N            | 房间的 id    |
| name     | String   | N            | 新的房间名称 |

响应 data 参数: 无

### 对房间做排序

说明：客户端必须将家庭下的所有房间上传，统一排序

URL：/v2/family/room/index

请求方法：POST

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                                                                                         |
| :------- | :------- | :----------- | :----------------------------------------------------------------------------------------------- |
| familyid | String   | Y            | 家庭 id，不填则为修改当前家庭                                                                    |
| idList   | Array    | N            | 房间的 id 列表，服务端按照列表的顺序对相应位置的 id 作排序，比如列表序号 0 的房间的 index 即为 0 |

响应 data 参数: 无

### 删除家庭

URL：/v2/family

请求方法：DELETE

认证参数：accessToken

请求参数：

| **名称**     | **类型** | **允许为空** | **说明**                                          |
| :----------- | :------- | :----------- | :------------------------------------------------ |
| id           | String   | N            | 家庭 id                                           |
| deviceFamily | String   | N            | 表示把将要删除的家庭下的设备迁移到另一个家庭的 id |
| switchFamily | String   | N            | 表示删除家庭后要切换到的家庭 id                   |

响应 data 参数: 无

### 删除房间

URL：/v2/family/room

请求方法：DELETE

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明** |
| :------- | :------- | :----------- | :------- |
| id       | String   | N            | 房间 id  |

响应 data 参数: 无

### 对家庭下的 Thing 做排序

说明：客户端必须将家庭下的所有设备和群组上传，统一排序

URL：/v2/family/thing/sort

请求方法：POST

认证参数：accessToken

请求参数：

| **名称**  | **类型**        | **允许为空** | **说明**                                                                                          |
| :-------- | :-------------- | :----------- | :------------------------------------------------------------------------------------------------ |
| familyid  | String          | Y            | 家庭 id，如果为空，表示对当前家庭下的设备/群组做排序                                              |
| thingList | Array\<Object\> | N            | thing 列表，服务端按照列表的顺序对相应位置的 id 作排序，比如列表序号 0 的设备/群组的 index 即为 0 |

thingList 列表 item 说明:

| **名称** | **类型** | **允许为空** | **说明**                                                   |
| :------- | :------- | :----------- | :--------------------------------------------------------- |
| itemType | Int      | N            | item 的类型 1=用户自己的设备 2=别人分享的设备 3=自己的群组 |
| id       | String   | N            | 设备 deviceid / 群组 id                                    |

响应 data 参数: 无

### 设置房间的 Thing

说明：客户端将房间原有的 thing 列表和调整后的 thing 列表传入，服务端据此计算出要从房间删除的 thing，以及要添加到房间的 thing。客户端应保证 oldThingList 的正确性，如果有遗漏项，可能导致从房间删除失败；如果其中一项不属于 roomid 所属的房间，服务端返回错误

URL：/v2/family/room/thing

请求方法：POST

认证参数：accessToken

请求参数：

| **名称**     | **类型** | **允许为空** | **说明**                                                                                                                   |
| :----------- | :------- | :----------- | :------------------------------------------------------------------------------------------------------------------------- |
| roomid       | String   | N            | 房间 id                                                                                                                    |
| oldThingList | Array    | N            | 原来房间的 thing 列表，如果为空，则传入空列表 []，列表的 item 参见【对家庭下的 Thing 做排序】中的 thingList 列表 item 说明 |
| newThingList | Array    | N            | 调整后房间的 thing 列表                                                                                                    |

响应 data 参数: 无

### 切换当前家庭

URL：/v2/family/current

请求方法：POST

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明** |
| :------- | :------- | :----------- | :------- |
| id       | String   | N            | 家庭 id  |

响应 data 参数: 无

## 消息中心

### 获取通知消息列表

说明：列表按时间排序，客户端如果要获取更多的数据，可以根据最后一个 item 的时间戳，再此调用此接口，将时间戳填到 from 字段中

URL：/v2/message/read

请求方法：GET

认证参数：accessToken

请求参数：

| **名称** | **类型** | **允许为空** | **说明**                                                                         |
| :------- | :------- | :----------- | :------------------------------------------------------------------------------- |
| familyid | String   | Y            | 家庭 id，如果不填则默认为当前家庭                                                |
| from     | Long     | Y            | 时间戳，精确到毫秒，表示从什么时间开始，获取更早之前的消息，不填则默认为当前时间 |
| num      | Int      | Y            | 最多拉取的消息数量，1<= num <= 30，不填则默认为 30                               |

响应 data 参数:

| **名称**    | **类型** | **允许为空** | **说明** |
| :---------- | :------- | :----------- | :------- |
| messageList | Array    | N            | 消息列表 |

messageList 列表 item 说明:

| **名称** | **类型** | **允许为空** | **说明**                                                                                                                                                                                                    |
| :------- | :------- | :----------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| msgid    | String   | N            | 消息 id                                                                                                                                                                                                     |
| msgType  | String   | N            | 消息类型 shareNotify_v2: 分享通知 cancelShareNotify_v2: 取消设备分享通知 opsNotify_v2: 设备操作通知 pushNotify_v2: 设备普通推送通知 alarmNotify_v2: 设备报警推送通知 IOTCameraNotify_v2: IOT 摄像头推送通知 |
| message  | Object   | N            | 消息内容，不同 msgType 可以有不同的结构定义                                                                                                                                                                 |
| date     | Long     | N            | 消息的时间戳，精确到毫秒                                                                                                                                                                                    |

响应 data 参数: 无

## 实时设备控制

**我们推荐使用使用这种方式实时管理和控制设备，这样可以避免频繁请求接口对服务器造成压力。**

完整流程说明：

客户端（APP、小程序、Web 网页或者其他）请求分配服务接口，获取建立 Websocket 的 IP 地址+端口。

拼接 wss 地址：wss:// {domain 或 IP}:{port}/api/ws

建立连接后，发送 WebSocket：握手相关参数，通过认证后，就成功建立连接了，然后就可以下发控制指令和接收设备或者服务端上报信息。

### HTTP : 分配服务（APP）

App 使用的长连接分配地址接口：

- 中国: [https://cn-dispa.coolkit.cn/dispatch/app](https://cn-dispa.coolkit.cn/dispatch/app)
- 美洲: [https://us-dispa.coolkit.cc/dispatch/app](https://us-dispa.coolkit.cc/dispatch/app)
- 欧洲: [https://eu-dispa.coolkit.cc/dispatch/app](https://eu-dispa.coolkit.cc/dispatch/app)
- 亚洲: [https://as-dispa.coolkit.cc/dispatch/app](https://as-dispa.coolkit.cc/dispatch/app)

中国境内微信使用的长连接分配地址接口：https://wx-disp.coolkit.cn:8080/dispatch/app

请求方法：GET

认证方式：无

请求参数：无

说明：请注意中国区和测试区使用的域名是 coolkit.**cn**，而海外区使用的域名是 coolkit.**cc**

**响应参数：**

| 名称   | 类型   | 允许为空 | 说明                                           |
| :----- | :----- | :------- | :--------------------------------------------- |
| IP     | string | N        | 长连接服务器外网 IP                            |
| port   | number | N        | 长连接服务器外网端口                           |
| domain | string | N        | 长连接服务器域名。客户端建立长连接时使用该域名 |
| error  | number | N        | 成功返回 error:0                               |
| reason | string | N        | 成功返回 ok                                    |

错误码：

0: 成功

**返回示例：**

```json
{
  "port": 8080,
  "IP": "52.80.19.131",
  "reason": "ok",
  "domain": "cn-pconnect2.coolkit.cc",
  "error": 0
}
```

### WebSocket：握手

连接建立时的认证，握手分客户端和设备端，此处为客户端的握手。

以下为参数:

| 名称      | 类型   | 允许为空 | 说明                            |
| :-------- | :----- | :------- | :------------------------------ |
| action    | string | N        | 固定参数: userOnline            |
| at        | string | N        | 登录接口获取的 AT               |
| apikey    | string | N        | 用户 apikey（可从登陆接口获取） |
| appid     | string | N        | APPID                           |
| nonce     | string | N        | 8 位字母数字随机数              |
| ts        | number | Y        | 时间戳精确到秒                  |
| userAgent | string | N        | 固定参数: app                   |
| sequence  | string | N        | 时间戳精确到毫秒                |
| version   | number | N        | 接口版本: 8                     |

示例：

```json
{
  "action": "userOnline",
  "version": 8,
  "ts": 1571141259,
  "at": "登录接口获取的AT",
  "userAgent": "app",
  "apikey": "登录接口获取的用户APIKEY",
  "appid": "McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
  "nonce": "2plz69ax",
  "sequence": "毫秒级时间戳，示例：1571141530100"
}
// 需去掉空格压缩, 不要带多余的逗号
```

**响应参数：**

| 名称     | 类型   | 允许为空 | 说明             |
| :------- | :----- | :------- | :--------------- |
| error    | number | N        | 错误码           |
| apikey   | string | N        | 用户 apikey      |
| config   | string | Y        | 配置信息         |
| sequence | string | N        | 时间戳精确到毫秒 |

Config 说明:

| 名称       | 类型   | 允许为空 | 说明                                                                                                                  |
| :--------- | :----- | :------- | :-------------------------------------------------------------------------------------------------------------------- |
| hb         | number | Y        | 心跳开关，是否需要发送心跳。0: 不需要， 1: 需要                                                                       |
| hbInterval | number | Y        | 心跳间隔，以秒为单位，客户端可以把这个值减上 7 作为间隔时间发送保持存活 ping 心跳，如果为空，默认以 90 秒为间隔发送。 |

易微联客户端的做法是：间隔时间 = config.hbInterval * random(0.8, 1); // 返回时间*0.8 到 1.0 的随机数

错误码：

0: 成功

**返回示例：**

```json
{
  "error": 0,
  "apikey": "用户APIKEY",
  "config": {
    "hb": 1,
    "hbInterval": 145
  },
  "sequence": "毫秒级时间戳，示例：1571141530100" // 和发送的一样
}
```

### WebSocket: 设备上线离线通知（APP 接收即可）

服务端检测到设备上线或者下线以后，会向 app 发送通知指令，该指令 app 端是**被动接收，不需要客户端主动发送**。

参数:

| 名称     | 类型   | 允许为空 | 说明                            |
| :------- | :----- | :------- | :------------------------------ |
| action   | string | N        | 固定参数: sysmsg                |
| apikey   | string | N        | 用户 apikey（可从登陆页面获取） |
| nonce    | string | N        | 8 位字母数字随机数              |
| ts       | number | Y        | 时间戳精确到秒，                |
| deviceid | string | N        | 设备 ID                         |
| params   | object | N        | 参数: {k:v}                     |

示例：

```json
{
  "action": "sysmsg",
  "deviceid": "1000000001",
  "apikey": "用户APIKEY",
  "ts": 15452192511,
  "params": {
    "online": false
  }
}
```

### WebSocket: 更新设备状态

**设备状态改变上报 update 指令后，只要客户端建立了长连接，就可以收到信息，所以建议客户端保持长连接监测设备状态或者发送查询指令获取单个设备状态，而不是定时请求 HTTP 接口获取设备状态，避免对服务器造成较大的负担。**

更改设备的状态，比如: 定时器、分享、开关状态等。

参数:

| 名称       | 类型   | 允许为空 | 说明                                                                                         |
| :--------- | :----- | :------- | :------------------------------------------------------------------------------------------- |
| action     | string | N        | 固定参数: update                                                                             |
| apikey     | string | N        | 用户 apikey（可从登录接口获取）或 主人账号的 apikey（可从获取 Thing 列表接口中获取）         |
| selfApikey | string | Y        | 接收方的 apikey ，接收方更新设备状态时，该字段必传，不允许为空                               |
| deviceid   | string | N        | 设备 ID                                                                                      |
| params     | object | N        | 服务端对于 params 参数采用透传方式，可能是对象也可能是对象数组。只需要发送期望改变的状态参数 |
| userAgent  | string | N        | app 或者 device                                                                              |
| sequence   | string | N        | 时间戳精确到毫秒                                                                             |

示例：

```json
{
  "action": "update",
  "deviceid": "100000001",
  "apikey": "当前用户APIKEY",
  "userAgent": "app",
  "sequence": "1585297259553",
  "params": {
    "switch": "on" // 单通道设备
  }
}
```

如若更新其他用户分享给自己的设备状态：

```json
{
  "action": "update",
  "deviceid": "100000001",
  "apikey": "主人账号的APIKEY",
  "selfApikey": "接收方账号的APIKEY",
  "userAgent": "app",
  "sequence": "1585297259553",
  "params": {
    "switch": "on" // 单通道设备
  }
}
```

params 说明:

此参数内容来自于协议文档，不同设备不同协议内容，比如 单通道开关只有一个 switch，但多通道设备肯定不止一个 switch，灯类设备还能调色调光，参数也有所不同。

协议文档需要向对接销售获取，公版易微联 APP 未对接设备（无 UI）的，如果定制界面需要额外付费，具体情况可咨询对接销售。

**响应参数：**

| 名称     | 类型   | 允许为空 | 说明             |
| :------- | :----- | :------- | :--------------- |
| error    | number | N        | 错误码           |
| apikey   | string | Y        | 用户 apikey      |
| deviceid | string | Y        | 设备 ID          |
| sequence | string | N        | 时间戳精确到毫秒 |

示例：

```json
{
  "error": 0,
  "deviceid": "1000000001",
  "apikey": "***************",
  "sequence": "1585297259553"
}
```

错误码：

504: 设备未回应（离线或者指令错误）

**定时器设置**

总体说明，设备可以添加多个定时器，每一次新增、修改、删除定时器的时候，都要全量提交定时器数组。

比如目前定时器有两个，那么如果再新增一个，那么提交的 timers 数组里，除了新增的这个定时器信息以外还要包含之前那两个定时器的信息。

timers 参数说明：

| 名称               | 类型   | 允许为空 | 说明                                                                          |
| :----------------- | :----- | :------- | :---------------------------------------------------------------------------- |
| enabled            | number | N        | 是否启用: 0 表示禁用；1 表示启用                                              |
| mId                | string | N        | 定时标记，可以理解为该定时器的 ID，不能重复，UUID 格式，可以使用库生成        |
| type               | string | N        | 设备端使用，单次定时 once；重复定时 repeat；循环定时 duration；               |
| coolkit_timer_type | string | N        | 客户端使用，单次定时 once；重复定时 repeat；循环定时 duration；延时定时 delay |
| at                 | string | N        | 执行时间: 格林尼治时间，也可采用 UTC 时间                                     |
| do                 | object | Y        | 要执行的动作                                                                  |
| startDo            | object | Y        | 循环定时专用: 周期开始要执行的动作                                            |
| endDo              | object | Y        | 循环定时专用: 随后再执行的动作                                                |
| period             | string | Y        | 延时定时专用: 延时时间，单位为分钟                                            |

示例：

单次定时，也就是只会执行一次:

```json
"params":{
        "timers":[
            {
                "enabled":1, //1表示启用
                "mId":"c102f00f-db6f-fef0-f296-9dd10fdc2193", //UUID格式，可以用库生成，给app用来标记
                "type":"once",  //设备端专用once表示单次定时，repeat重复定时
                "at":"2017-07-24T08:28:00.000Z", //执行的时间 ，注意是GTM时间   0时区
                "do":{   //具体要执行的操作
                    "switch":"on"   //这里是执行打开单通道开关的操作。如果是多通道，这里放的是多通道的开关格式。
                },
                "coolkit_timer_type":"once" //app专用
            }
        ]
    }
```

重复定时:

```json
"params":{
        "timers":[
            {
                "enabled":1,
                "mId":"847b296e-9043-ac94-ca37-aa5f91d22338",
                "type":"repeat", //重复执行
                "at":"36 8 * * 1,3",//时间表达式参考cron
                "do":{
                    "switch":"on"
                },
                "coolkit_timer_type":"repeat" //重复执行
            }
        ]
    }
```

循环定时:

```json
"params":{
        "timers":[
            {
                "enabled":1,
                "mId":"847b296e-9043-ac94-ca37-aa5f91d22338",
                "type":"duration",
                "at":"2018-11-21T10:24:00.980Z 10 5",//循环定时执行时间 循环周期 10分钟 再执行 5分钟
                "startDo":{
                    "switch":"on"  //周期开始执行
                },
                "endDo":{
                    "switch":"off"  //随后再执行
                },
                "coolkit_timer_type":"duration" //重复执行
            }
        ]
    }
```

延时定时（指定在多少分钟后执行，也就是单次执行，只是为了可以快速添加定时器）:

```json
"params":{
        "timers":[
            {
                "enabled":1,
                "mId":"95303c64-fbb4-f497-1341-c592432d1d0d",
                "type":"once",
                "at":"2017-07-24T09:10:43.223Z",
                "do":{
                    "switch":"on"
                },
                "period":"30",
                "coolkit_timer_type":"delay"  //延时定时
            }
        ]
    }
```

### WebSocket: 查询设备状态

查询设备的状态，比如: 定时器、分享、开关状态等。

参数:

| 名称      | 类型   | 允许为空 | 说明                                                   |
| :-------- | :----- | :------- | :----------------------------------------------------- |
| action    | string | N        | 固定参数: query                                        |
| apikey    | string | N        | 当前用户 apikey（可从登陆页面获取）                    |
| deviceid  | string | N        | 设备 ID                                                |
| params    | array  | N        | 字符串数组，指定要查询的参数。如果为空表示查询所有参数 |
| userAgent | string | N        | app 或者 device                                        |
| sequence  | string | N        | 时间戳精确到毫秒                                       |

示例：

```json
{
  "action": "query",
  "deviceid": "1000000001",
  "apikey": "当前用户APIKEY",
  "sequence": "1585297259553",
  "params": ["switch", "timers"], // 如果返回为空，可以使用[]查询所有字段状态
  "userAgent": "app"
}
```

如若查询其他用户分享给自己的设备状态：

```json
{
    "action":"query",
    "userAgent":"app",
    "apikey":"主人账号APIKEY",
    "deviceid":"1000000001",
    "params":["switch","timers"],
    "sequence":"1585297259553",
    "selfApikey":"当前用户APIKEY"}
}
```

params 说明:

此参数内容来自于协议文档，不同设备不同协议内容，比如 单通道开关只有一个 switch，但多通道设备肯定不止一个 switch，灯类设备还能调色调光，参数也有所不同。

协议文档需要向对接销售索要，公版易微联 APP 未对接设备（无 UI）的，如果定制需要额外付费，具体内容咨询对接销售。

**响应参数：**

| 名称     | 类型   | 允许为空 | 说明                    |
| :------- | :----- | :------- | :---------------------- |
| error    | number | N        | 错误码                  |
| apikey   | string | N        | 用户 apikey             |
| deviceid | string | N        | 设备 ID                 |
| params   | object | N        | 透传参数,服务端不做验证 |

示例：

```json
{
    "error":0,
    "deviceid":"1000000001",
    "apikey":"***************",
    "params":{
        "switch":"on",
      ...
    }
}
```

## 错误码

### 通用错误码

| **错误码** | **说明**                                                                                                 |
| :--------- | :------------------------------------------------------------------------------------------------------- |
| 400        | 参数错误，通常是缺少接口必须的参数，或者参数的类型或值错误                                               |
| 401        | access token 认证错误，通常是账号被其他人登录，导致当前 access token 失效                                |
| 402        | access token 过期                                                                                        |
| 403        | 找不到接口，通常是接口 url 写错                                                                          |
| 405        | 找不到资源，通常是在后端数据库中查不到必需的数据记录                                                     |
| 406        | 拒绝操作，通常是当前用户无权操作指定资源                                                                 |
| 407        | appid 无操作权限                                                                                         |
| 500        | 服务器内部错误，通常是服务端的程序出错                                                                   |
| 4002       | 设备已离线（旧的错误码，为避免对已使用更新设备状态接口的客户造成影响，暂时先不改），更新设备状态中会出现 |

### 【用户】相关错误码

| **错误码** | **说明**                   |
| :--------- | :------------------------- |
| 10001      | 登录密码错误               |
| 10002      | 验证码错误                 |
| 10003      | 用户不存在                 |
| 10004      | 登录的用户不在本区域       |
| 10009      | 注册用户时检查到账号已存在 |
| 10010      | 验证码发送频率过快         |

### 【家庭和房间】相关错误码

| **错误码** | **说明**                       |
| :--------- | :----------------------------- |
| 20001      | 首次创建家庭失败               |
| 20002      | 创建家庭或房间时，数量超出限制 |
| 20003      | 只有一个家庭，拒绝删除         |

### 【设备】相关错误码

| **错误码** | **说明**                                                          |
| :--------- | :---------------------------------------------------------------- |
| 30003      | 添加 GSM 设备时，发送 notify 通知（以告知设备断开临时长连接）失败 |
| 30007      | 添加 GSM 时，因为设备已经被其他账号添加，导致本次添加失败         |
| 30008      | 分享设备时，分享者的账号不存在                                    |
| 30009      | 新增设备群组超过了数量限制                                        |
| 30010      | 添加设备时，设备 id 格式错误                                      |
| 30011      | 添加设备时，出厂信息不存在                                        |
| 30012      | 添加设备时，出厂信息的 extra 字段不存在                           |
| 30013      | 添加设备时，出厂 信息中的品牌信息不存在                           |
| 30014      | 添加设备时，chipid 错误                                           |
| 30015      | 添加设备时，digest 错误                                           |
| 30016      | 添加设备时，appid 信息不存在                                      |
| 30017      | 添加设备时，拒绝该 appid 登录的用户添加该品牌的设备               |
| 30018      | 添加设备时，找不到 deviceid 对应的设备信息                        |
| 30019      | 添加设备时，出厂信息中的产品型号信息不存在                        |
| 30022      | 设备已离线，操作失败，批量更新设备状态中会出现                    |
